@{
    ViewData["Title"] = "Movimentos Manuais";
}

<h1 class="mb-4">Movimentos Manuais</h1>

<div class="card">
    <div class="card-body">
        <form id="formMovimento">
            <div class="row">
                <div class="col-md-3">
                    <label for="mes" class="form-label">Mês</label>
                    <input type="number" class="form-control" id="mes" required disabled>
                </div>
                <div class="col-md-3">
                    <label for="ano" class="form-label">Ano</label>
                    <input type="number" class="form-control" id="ano" required disabled>
                </div>
                <div class="col-md-3">
                    <label for="produto" class="form-label">Produto</label>
                    <select class="form-select" id="produto" required disabled></select>
                </div>
                <div class="col-md-3">
                    <label for="cosif" class="form-label">Cosif</label>
                    <select class="form-select" id="cosif" required disabled></select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-3">
                    <label for="valor" class="form-label">Valor</label>
                    <input type="text" class="form-control" id="valor" required disabled>
                </div>
                <div class="col-md-9">
                    <label for="descricao" class="form-label">Descrição</label>
                    <textarea class="form-control" id="descricao" rows="1" required disabled></textarea>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col text-end">
                    <button type="button" class="btn btn-secondary" id="btnLimpar">Limpar</button>
                    <button type="button" class="btn btn-primary" id="btnNovo">Novo</button>
                    <button type="submit" class="btn btn-success" id="btnIncluir" disabled>Incluir</button>
                </div>
            </div>
        </form>
    </div>
</div>

<h2 class="mt-5">Movimentos</h2>
<table class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Mês</th>
            <th>Ano</th>
            <th>Código do Produto</th>
            <th>Descrição do Produto</th>
            <th>NR Lançamento</th>
            <th>Descrição</th>
            <th>Valor</th>
        </tr>
    </thead>
    <tbody id="gridMovimentos">
    </tbody>
</table>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('formMovimento');
            const mesInput = document.getElementById('mes');
            const anoInput = document.getElementById('ano');
            const produtoSelect = document.getElementById('produto');
            const cosifSelect = document.getElementById('cosif');
            const valorInput = document.getElementById('valor');
            const descricaoInput = document.getElementById('descricao');
            const btnNovo = document.getElementById('btnNovo');
            const btnLimpar = document.getElementById('btnLimpar');
            const btnIncluir = document.getElementById('btnIncluir');
            const gridBody = document.getElementById('gridMovimentos');

            const inputs = [mesInput, anoInput, produtoSelect, cosifSelect, valorInput, descricaoInput];

            function habilitarCampos(habilitar) {
                inputs.forEach(input => input.disabled = !habilitar);
                btnIncluir.disabled = !habilitar;
            }

            function limparCampos() {
                form.reset();
                cosifSelect.innerHTML = '<option value="">-- Selecione o Produto 1º --</option>';
            }

            async function carregarMovimentos() {
                const response = await fetch('/api/movimentos');
                const data = await response.json();
                gridBody.innerHTML = '';
                data.forEach(mov => {
                    gridBody.innerHTML += `
                        <tr>
                            <td>${mov.mes}</td>
                            <td>${mov.ano}</td>
                            <td>${mov.codProduto}</td>
                            <td>${mov.nomeProduto}</td>
                            <td>${mov.numLancamento}</td>
                            <td>${mov.descricao}</td>
                            <td>${mov.valor.toFixed(2)}</td>
                        </tr>
                    `;
                });
            }

            async function carregarProdutos() {
                const response = await fetch('/api/movimentos/produtos');
                const data = await response.json();
                produtoSelect.innerHTML = '<option value="">-- Selecione --</option>';
                data.forEach(prod => {
                    produtoSelect.innerHTML += `<option value="${prod.codProduto}">${prod.desProduto}</option>`;
                });
            }

            async function carregarCosif(codProduto) {
                if (!codProduto) {
                    cosifSelect.innerHTML = '<option value="">-- Selecione o Produto 1º --</option>';
                    return;
                }
                const response = await fetch(`/api/movimentos/produtos/${codProduto}/cosif`);
                const data = await response.json();
                cosifSelect.innerHTML = '';
                data.forEach(cosif => {
                    cosifSelect.innerHTML += `<option value="${cosif.codCosif}">${cosif.codCosif} - ${cosif.codClassificacao}</option>`;
                });
            }

            btnNovo.addEventListener('click', () => {
                habilitarCampos(true);
                limparCampos();
                mesInput.focus();
            });

            btnLimpar.addEventListener('click', () => {
                limparCampos();
            });

            produtoSelect.addEventListener('change', () => {
                carregarCosif(produtoSelect.value);
            });

            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                const novoMovimento = {
                    datMes: parseInt(mesInput.value),
                    datAno: parseInt(anoInput.value),
                    codProduto: produtoSelect.value,
                    codCosif: cosifSelect.value,
                    valValor: parseFloat(valorInput.value),
                    desDescricao: descricaoInput.value
                };

                const response = await fetch('/api/movimentos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(novoMovimento)
                });

                if (response.ok) {
                    limparCampos();
                    habilitarCampos(false);
                    await carregarMovimentos();
                } else {
                    alert('Erro ao incluir movimento.');
                }
            });

            // Carga inicial
            carregarMovimentos();
            carregarProdutos();
        });
    </script>
}